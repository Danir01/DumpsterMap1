# Инструкция по интеграции обученной модели TensorFlow Lite

## Обзор

В приложение интегрирована поддержка TensorFlow Lite моделей для точного распознавания типов отходов. Система автоматически использует обученную модель, если она доступна, иначе использует ML Kit как запасной вариант.

## Архитектура системы

```
WasteClassifier
├── TensorFlow Lite модель (приоритет 1) - если модель загружена
├── ML Kit Object Detection (приоритет 2) - если модель не загружена
└── ML Kit Image Labeling (приоритет 3) - запасной вариант
```

## Структура файлов

```
app/src/main/
├── assets/
│   └── ml_models/
│       ├── waste_classifier.tflite  ← Модель TensorFlow Lite
│       └── waste_labels.txt          ← Метки классов (уже создан)
└── java/com/example/trashmap/AI/
    ├── TensorFlowLiteWasteClassifier.java  ← Класс для работы с моделью
    └── WasteClassifier.java                ← Главный классификатор
```

## Как добавить модель

### Вариант 1: Использовать готовую модель

1. **Найдите или создайте модель TensorFlow Lite**
   - Модель должна быть обучена на классификации отходов
   - Формат: `.tflite`
   - Рекомендуемый размер входного изображения: 224x224 или 299x299 пикселей
   - Количество выходных классов: 11 (соответствует типам отходов в приложении)

2. **Поместите модель в проект**
   - Скопируйте файл модели в: `app/src/main/assets/ml_models/waste_classifier.tflite`
   - Убедитесь, что файл называется именно `waste_classifier.tflite`

3. **Настройте метки классов**
   - Файл `waste_labels.txt` уже создан
   - Убедитесь, что порядок меток соответствует порядку классов в модели
   - Каждая метка на новой строке

### Вариант 2: Обучить свою модель

#### Использование TensorFlow/Keras:

```python
# Пример структуры модели
import tensorflow as tf
from tensorflow import keras

# Создание модели
model = keras.Sequential([
    keras.layers.Input(shape=(224, 224, 3)),
    keras.layers.Rescaling(1./255),
    keras.layers.Conv2D(32, 3, activation='relu'),
    keras.layers.MaxPooling2D(),
    keras.layers.Conv2D(64, 3, activation='relu'),
    keras.layers.MaxPooling2D(),
    keras.layers.Conv2D(128, 3, activation='relu'),
    keras.layers.MaxPooling2D(),
    keras.layers.Flatten(),
    keras.layers.Dense(128, activation='relu'),
    keras.layers.Dense(11, activation='softmax')  # 11 классов отходов
])

# Компиляция и обучение
model.compile(
    optimizer='adam',
    loss='categorical_crossentropy',
    metrics=['accuracy']
)

# Обучение на датасете отходов
model.fit(train_dataset, epochs=10, validation_data=val_dataset)

# Конвертация в TensorFlow Lite
converter = tf.lite.TFLiteConverter.from_keras_model(model)
tflite_model = converter.convert()

# Сохранение модели
with open('waste_classifier.tflite', 'wb') as f:
    f.write(tflite_model)
```

#### Использование Firebase AutoML:

1. Создайте проект в Firebase Console
2. Перейдите в ML Kit → Custom Image Classification
3. Загрузите датасет с изображениями отходов
4. Обучите модель
5. Экспортируйте модель в формат TensorFlow Lite
6. Поместите модель в `app/src/main/assets/ml_models/`

## Требования к модели

### Входные данные:
- **Формат**: RGB изображение
- **Размер**: 224x224 пикселей (можно изменить в коде)
- **Тип данных**: Float32
- **Нормализация**: Значения от 0.0 до 1.0

### Выходные данные:
- **Формат**: Массив вероятностей для каждого класса
- **Количество классов**: 11 (соответствует типам отходов)
- **Активация**: Softmax (сумма вероятностей = 1.0)

### Порядок классов в модели:
1. Бытовые отходы (id: 0)
2. Пластик (id: 1)
3. Стекло (id: 2)
4. Металл (id: 3)
5. Батарейки (id: 4)
6. Макулатура (id: 5)
7. Древесина (id: 6)
8. Электроника (id: 7)
9. Нефть (id: 8)
10. Отработанные масла (id: 9)
11. Одежда (id: 10)

## Настройка маппинга классов

Если ваша модель обучена на других классах, нужно настроить маппинг в файле `TensorFlowLiteWasteClassifier.java`:

```java
// Маппинг индексов классов модели к типам отходов в приложении
private static final int[] MODEL_TO_WASTE_TYPE = {
    0,  // Класс 0 модели → Бытовые отходы
    1,  // Класс 1 модели → Пластик
    // ... и т.д.
};
```

## Проверка работы модели

1. **Запустите приложение**
2. **Откройте Logcat** и отфильтруйте по тегу `TFLiteWasteClassifier`
3. **Проверьте логи**:
   - `Модель успешно загружена` - модель найдена и загружена
   - `Используем TensorFlow Lite модель для классификации` - модель используется
   - `Результаты классификации:` - покажет вероятности для каждого класса

## Если модель не загружается

1. **Проверьте наличие файла**:
   - Путь: `app/src/main/assets/ml_models/waste_classifier.tflite`
   - Имя файла должно быть точно `waste_classifier.tflite`

2. **Проверьте размер файла**:
   - Модель не должна быть пустой
   - Обычно размер от 1 МБ до 50 МБ

3. **Проверьте формат**:
   - Файл должен быть в формате TensorFlow Lite (.tflite)
   - Не должен быть сжат (уже настроено в build.gradle)

4. **Проверьте логи**:
   - Ищите ошибки с тегом `TFLiteWasteClassifier`
   - Система автоматически переключится на ML Kit, если модель не загрузится

## Оптимизация модели

### Квантование (уменьшение размера):
```python
converter = tf.lite.TFLiteConverter.from_keras_model(model)
converter.optimizations = [tf.lite.Optimize.DEFAULT]
tflite_model = converter.convert()
```

### Использование GPU:
Модель автоматически использует GPU, если доступно (зависимость `tensorflow-lite-gpu` уже добавлена).

## Где найти готовые модели

1. **Kaggle Datasets**: Поищите датасеты по запросу "waste classification" или "trash classification"
2. **GitHub**: Множество открытых моделей для классификации отходов
3. **TensorFlow Hub**: Готовые предобученные модели
4. **Firebase AutoML**: Обучение собственной модели через веб-интерфейс

## Примеры датасетов для обучения

- **TrashNet**: https://github.com/garythung/trashnet
- **Waste Classification Dataset**: Различные датасеты на Kaggle
- **TACO Dataset**: Dataset for object detection in waste

## Дополнительные настройки

### Изменение размера входного изображения:

В файле `TensorFlowLiteWasteClassifier.java`:
```java
private static final int INPUT_IMAGE_WIDTH = 224;  // Измените на размер вашей модели
private static final int INPUT_IMAGE_HEIGHT = 224;
```

### Изменение порога уверенности:

В методе `processResults()` можно добавить проверку минимальной уверенности:
```java
if (maxProbability < 0.5f) {
    // Низкая уверенность, возможно использовать запасной вариант
}
```

## Поддержка

Если у вас возникли проблемы:
1. Проверьте логи в Logcat
2. Убедитесь, что модель соответствует требованиям
3. Проверьте, что файл модели находится в правильной папке
4. Система автоматически использует ML Kit, если модель недоступна

